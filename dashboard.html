<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Profissional ‚Äî Par√≥quia de S√£o Paulo de Luanda</title>
  
  <!-- SheetJS -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- html2canvas para exportar gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    :root {
      --bg: #fffdf6; --card: #ffffff; --ink: #1b1a17; --muted: #6b7280;
      --accent: #c28402; --accent-2: #d39f21; --ok: #16a34a; --warn: #b45309;
      --border: #ecd39a; --border-light: #f0e1b6; --radius: 16px;
      --error: #dc2626; --info: #2563eb;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
    .card {
      width: 100%; background: var(--card); border-radius: var(--radius);
      box-shadow: -1px 9px 8px rgba(0,0,0,0.08); margin-bottom: 16px;
      position: relative;
    }
    .hero-brand {
      width: 100%; padding: 16px; display: flex; gap: 16px; align-items: center;
    }
    .hero-brand img {
      width: 72px; height: auto; border-radius: 12px;
      border: 1px solid var(--border); background: #fff; padding: 4px;
    }
    .title { font-weight: 800; font-size: 18px; }
    .subtitle { font-weight: 700; color: var(--muted); }
    .info { margin-top: 6px; font-weight: 800; font-size: 16px; }
    .meta { color: #374151; margin-top: 2px; font-size: 14px; }
    
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 16px; }
    .btn {
      background: var(--accent); color: #fff; border: 0; padding: 8px 12px;
      border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none;
      display: inline-flex; align-items: center; gap: 4px; font-size: 14px;
    }
    .btn.secondary { background: #fff; color: var(--accent); border: 1px solid var(--accent); }
    .btn.small { padding: 4px 8px; font-size: 12px; }
    .btn:hover { background: var(--accent-2); transform: translateY(-1px); }
    .btn.secondary:hover { background: var(--accent); color: #fff; }
    
    .debug-upload {
      margin: 16px 0; padding: 16px; border: 2px dashed #dc2626;
      border-radius: 12px; text-align: center; background: #fef2f2; color: #991b1b;
    }
    .debug-upload input[type="file"] { margin: 8px 0; } 
   
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .dashboard-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: -1px 9px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
      position: relative;
    }
    
    .dashboard-card.wide {
      grid-column: span 2;
    }
    
    .dashboard-card.full {
      grid-column: 1 / -1;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .card-header h3 {
      margin: 0;
      color: var(--accent);
      font-size: 16px;
      font-weight: 700;
    }
    
    .card-actions {
      display: flex;
      gap: 4px;
    }
    
    .stat-number {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--accent);
      margin: 8px 0;
      line-height: 1;
    }
    
    .stat-number.large {
      font-size: 3rem;
    }
    
    .stat-number.medium {
      font-size: 1.8rem;
    }
    
    .stat-number.small {
      font-size: 1.4rem;
    }
    
    .stat-label {
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 6px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin: 16px 0;
    }
    
    .chart-container.small {
      height: 200px;
    }
    
    .table-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 12px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .data-table th {
      background: #faf7ee;
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .data-table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .data-table tr:hover {
      background: #fffbf0;
    }
    
    .highlight-card {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      text-align: center;
      padding: 20px;
    }
    
    .highlight-card .stat-number {
      color: white;
    }
    
    .highlight-card .stat-label {
      color: rgba(255,255,255,0.9);
    }
    
    .age-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .age-badge.young {
      background: #dcfce7;
      color: #166534;
    }
    
    .age-badge.old {
      background: #fef3c7;
      color: #92400e;
    }
    
    .approval-rate {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }
    
    .approval-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .approval-indicator.high { background: var(--ok); }
    .approval-indicator.medium { background: var(--warn); }
    .approval-indicator.low { background: var(--error); }
    
    .footer { color: var(--muted); font-size: 12px; text-align: center; margin: 24px 0; }
    
    @media (max-width: 768px) {
      .container {
        padding: 8px;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .dashboard-card.wide,
      .dashboard-card.full {
        grid-column: 1;
      }
      
      .dashboard-card {
        padding: 12px;
      }
      
      .hero-brand {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      
      .actions {
        flex-direction: column;
        width: 100%;
      }
      
      .actions .btn {
        width: 100%;
        justify-content: center;
      }
      
      .stat-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-container {
        height: 250px;
      }
      
      .chart-container.small {
        height: 200px;
      }
      
      .stat-number.large {
        font-size: 2.5rem;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      .data-table {
        min-width: 600px;
      }
    }
  </style>
</head><b
ody>
  <header class="card">
    <div class="container">
      <div class="hero-brand card">
        <img id="logoImg" alt="Logo da Par√≥quia" onerror="this.style.display='none'"/>
        <div>
          <div class="title" id="paroquiaNome">A carregar...</div>
          <div class="subtitle" id="secretariado">A carregar...</div>
          <div class="info">Dashboard Profissional da Catequese</div>
          <div class="meta">Ano Catequ√©tico: <strong id="anoCatequetico">A carregar...</strong></div>
          <div class="meta">√öltima atualiza√ß√£o: <strong id="lastUpdate">-</strong></div>
        </div>
      </div>

      <!-- Debug Mode: File Upload (s√≥ aparece se DEBUG_MODE = true) -->
      <div id="debugUpload" class="debug-upload" style="display:none">
        <div><strong>üîß MODO DEBUG ATIVO</strong></div>
        <div>Carregar arquivo Excel para testes:</div>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <button class="btn" id="loadSampleBtn">üìä Usar Dados de Exemplo</button>
      </div>

      <div class="actions">
        <a href="index.html" class="btn">üìã Lista de Catec√∫menos</a>
        <a href="lista-catequistas.html" class="btn secondary">üë• Lista de Catequistas</a>
        <a href="aniversarios.html" class="btn secondary">üéÇ Anivers√°rios</a>
        <button class="btn secondary" id="refreshBtn">üîÑ Atualizar</button>
        <button class="btn secondary" id="exportAllBtn">üìä Exportar Tudo</button>
        <button class="btn secondary" id="printDashboard">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="dashboard-grid">
      
      <!-- Estat√≠sticas Principais -->
      <div class="dashboard-card highlight-card">
        <div class="stat-number large" id="totalCatecumenos">-</div>
        <div class="stat-label">Total de Catec√∫menos</div>
      </div>

      <div class="dashboard-card">
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-number medium" id="totalCatequistas">-</div>
            <div class="stat-label">Catequistas</div>
          </div>
          <div class="stat-item">
            <div class="stat-number medium" id="totalTurmas">-</div>
            <div class="stat-label">Turmas</div>
          </div>
          <div class="stat-item">
            <div class="stat-number medium" id="totalCentros">-</div>
            <div class="stat-label">Centros</div>
          </div>
          <div class="stat-item">
            <div class="stat-number medium" id="totalHorarios">-</div>
            <div class="stat-label">Hor√°rios</div>
          </div>
        </div>
      </div>

      <!-- Aprova√ß√£o Geral -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üìà Taxa de Aprova√ß√£o Geral</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('approvalCard', 'aprovacao_geral')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('approvalCard', 'aprovacao_geral')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="approvalCard">
          <div class="approval-rate">
            <div class="approval-indicator" id="approvalIndicator"></div>
            <div class="stat-number" id="approvalRate">-</div>
            <div class="stat-label">Taxa de Aprova√ß√£o</div>
          </div>
          <div id="approvalDetails"></div>
        </div>
      </div>

      <!-- Catec√∫menos Mais Novo e Mais Velho -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üë∂üë¥ Idades Extremas</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('ageCard', 'idades_extremas')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('ageCard', 'idades_extremas')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="ageCard">
          <div id="youngestStudent"></div>
          <div id="oldestStudent"></div>
        </div>
      </div> 
     <!-- Distribui√ß√£o por Centro -->
      <div class="dashboard-card wide">
        <div class="card-header">
          <h3>üè¢ Distribui√ß√£o por Centro</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('centroCard', 'distribuicao_centros')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('centroChart', 'centros_grafico')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="centroCard">
          <div class="chart-container small">
            <canvas id="centroChart"></canvas>
          </div>
          <div id="centroStats"></div>
        </div>
      </div>

      <!-- Distribui√ß√£o por Etapa -->
      <div class="dashboard-card wide">
        <div class="card-header">
          <h3>üìö Distribui√ß√£o por Etapa</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('etapaCard', 'distribuicao_etapas')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('etapaChart', 'etapas_grafico')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="etapaCard">
          <div class="chart-container small">
            <canvas id="etapaChart"></canvas>
          </div>
          <div id="etapaStats"></div>
        </div>
      </div>

      <!-- Distribui√ß√£o por Hor√°rio -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>‚è∞ Distribui√ß√£o por Hor√°rio</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('horarioCard', 'distribuicao_horarios')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('horarioCard', 'horarios_grafico')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="horarioCard">
          <div id="horarioStats"></div>
        </div>
      </div>

      <!-- Catequistas por Centro -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üë• Catequistas por Centro</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('catequistasCentroCard', 'catequistas_centro')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('catequistasCentroCard', 'catequistas_centro')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="catequistasCentroCard">
          <div id="catequistasCentroStats"></div>
        </div>
      </div>

      <!-- Turmas por Centro -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üè´ Turmas por Centro</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('turmasCentroCard', 'turmas_centro')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('turmasCentroCard', 'turmas_centro')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="turmasCentroCard">
          <div id="turmasCentroStats"></div>
        </div>
      </div>

      <!-- Ranking de Turmas -->
      <div class="dashboard-card full">
        <div class="card-header">
          <h3>üèÜ Ranking de Turmas</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('rankingCard', 'ranking_turmas')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('rankingCard', 'ranking_turmas')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="rankingCard">
          <div class="table-container">
            <table class="data-table" id="rankingTable">
              <thead>
                <tr>
                  <th>Posi√ß√£o</th>
                  <th>Centro</th>
                  <th>Etapa</th>
                  <th>Sala</th>
                  <th>Hor√°rio</th>
                  <th>Catequistas</th>
                  <th>Catec√∫menos</th>
                  <th>Taxa Aprova√ß√£o</th>
                </tr>
              </thead>
              <tbody id="rankingTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Aprova√ß√£o por Centro -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üìä Aprova√ß√£o por Centro</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('approvalCentroCard', 'aprovacao_centro')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('approvalCentroCard', 'aprovacao_centro')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="approvalCentroCard">
          <div id="approvalCentroStats"></div>
        </div>
      </div>

      <!-- Aprova√ß√£o por Etapa -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>üìà Aprova√ß√£o por Etapa</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('approvalEtapaCard', 'aprovacao_etapa')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('approvalEtapaCard', 'aprovacao_etapa')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="approvalEtapaCard">
          <div id="approvalEtapaStats"></div>
        </div>
      </div>

      <!-- Aprova√ß√£o por Hor√°rio -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3>‚è∞ Aprova√ß√£o por Hor√°rio</h3>
          <div class="card-actions">
            <button class="btn small secondary" onclick="exportCard('approvalHorarioCard', 'aprovacao_horario')">üìä XLSX</button>
            <button class="btn small secondary" onclick="exportChartAsPNG('approvalHorarioCard', 'aprovacao_horario')">üñºÔ∏è PNG</button>
          </div>
        </div>
        <div id="approvalHorarioCard">
          <div id="approvalHorarioStats"></div>
        </div>
      </div>

    </div>
  </main>

  <div class="footer" id="footerText">¬© Par√≥quia de S√£o Paulo de Luanda ‚Äî Secretariado da Catequese</div> 
 <script>
    // üîß DEBUG MODE: Altere para true para mostrar op√ß√£o de upload de arquivo
    const DEBUG_MODE = false;
    
    let CONFIG = null;
    let dashboardData = null;
    let charts = {};

    // Dados de exemplo expandidos
    const SAMPLE_DATA = [
      {
        nome: "Jo√£o Silva Santos", nascimento: "15/03/2010", centro: "Centro Principal",
        etapa: "1¬™ Etapa", sala: "101", horario: "S√°bado Manh√£",
        catequistas: "Maria Jos√©|Pedro Costa", resultado: "Aprovado"
      },
      {
        nome: "Ana Maria Fernandes", nascimento: "22/07/2009", centro: "Centro Norte",
        etapa: "2¬™ Etapa", sala: "205", horario: "Domingo Tarde",
        catequistas: "Carlos Silva", resultado: "Aprovado"
      },
      {
        nome: "Miguel Ant√≥nio Lopes", nascimento: "08/11/2011", centro: "Centro Sul",
        etapa: "1¬™ Etapa", sala: "102", horario: "S√°bado Tarde",
        catequistas: "Isabel Santos|Jo√£o Pereira", resultado: "Em Avalia√ß√£o"
      },
      {
        nome: "Beatriz Costa Rodrigues", nascimento: "14/05/2008", centro: "Centro Principal",
        etapa: "3¬™ Etapa", sala: "301", horario: "Domingo Manh√£",
        catequistas: "Ant√≥nio Silva", resultado: "Aprovado"
      },
      {
        nome: "Francisco Manuel Sousa", nascimento: "30/09/2010", centro: "Centro Norte",
        etapa: "2¬™ Etapa", sala: "203", horario: "S√°bado Manh√£",
        catequistas: "Teresa Lopes|Manuel Costa", resultado: "Reprovado"
      },
      {
        nome: "Lu√≠sa Pereira Gomes", nascimento: "12/01/2009", centro: "Centro Sul",
        etapa: "2¬™ Etapa", sala: "204", horario: "Domingo Tarde",
        catequistas: "Fernanda Lima", resultado: "Aprovado"
      },
      {
        nome: "Carlos Eduardo Martins", nascimento: "03/08/2007", centro: "Centro Principal",
        etapa: "4¬™ Etapa", sala: "401", horario: "S√°bado Manh√£",
        catequistas: "Rosa Silva", resultado: "Aprovado"
      },
      {
        nome: "Mariana Santos Oliveira", nascimento: "28/12/2012", centro: "Centro Norte",
        etapa: "1¬™ Etapa", sala: "103", horario: "Domingo Manh√£",
        catequistas: "Paulo Mendes", resultado: "Aprovado"
      },
      {
        nome: "Ricardo Pereira Lima", nascimento: "17/04/2009", centro: "Centro Sul",
        etapa: "3¬™ Etapa", sala: "302", horario: "S√°bado Tarde",
        catequistas: "Lucia Costa|Andr√© Silva", resultado: "Reprovado"
      },
      {
        nome: "Sofia Rodrigues Alves", nascimento: "09/06/2011", centro: "Centro Principal",
        etapa: "2¬™ Etapa", sala: "202", horario: "Domingo Tarde",
        catequistas: "Helena Santos", resultado: "Aprovado"
      }
    ];
    
    // Utilit√°rios
    const norm = (s) => (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
    const formatNumber = (num) => new Intl.NumberFormat('pt-AO').format(num);
    const nowStamp = () => {
      const d = new Date();
      return d.toLocaleString('pt-AO', { 
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }; 
   // Fun√ß√£o para calcular idade
    function calculateAge(birthDate) {
      if (!birthDate) return null;
      
      let birth;
      if (typeof birthDate === 'string' && birthDate.includes('/')) {
        const [day, month, year] = birthDate.split('/');
        birth = new Date(year, month - 1, day);
      } else {
        birth = new Date(birthDate);
      }
      
      if (isNaN(birth)) return null;
      
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      
      return age;
    }

    function mapHeaders(cols) {
      const wanted = {
        nome: ['nome', 'nomecompleto'],
        nascimento: ['nascimento', 'datanascimento', 'data', 'dn'],
        centro: ['centro', 'centrodecatequese', 'paroquia', 'comunidade'],
        etapa: ['etapa', 'etapacatequese', 'nivel', 'ano', 'classe'],
        sala: ['sala', 'numerosala', 'turma', 'salaaula'],
        horario: ['horario', 'hora', 'turno', 'periodo', 'diaehora', 'diahora'],
        catequistas: ['catequistas', 'catequista', 'responsaveis', 'responsavel'],
        resultado: ['resultado', 'situacao', 'status']
      };
      const idx = {};
      cols.forEach((c, i) => {
        const k = norm(c).replace(/[^a-z0-9]/g, '');
        for (const [t, aliases] of Object.entries(wanted)) {
          if (aliases.includes(k)) idx[t] = i;
        }
      });
      return idx;
    }

    // Carrega configura√ß√µes
    async function loadConfig() {
      try {
        const response = await fetch('config/settings.json?v=' + Date.now());
        if (!response.ok) throw new Error('Erro ao carregar configura√ß√µes: ' + response.status);
        CONFIG = await response.json();
        
        document.getElementById('logoImg').src = CONFIG.arquivos.logo;
        document.getElementById('paroquiaNome').textContent = CONFIG.paroquia.nome;
        document.getElementById('secretariado').textContent = CONFIG.paroquia.secretariado;
        document.getElementById('anoCatequetico').textContent = CONFIG.paroquia.ano_catequetico;
        document.getElementById('footerText').textContent = `¬© ${CONFIG.paroquia.nome} ‚Äî ${CONFIG.paroquia.secretariado}`;
        
        console.log('‚úÖ Configura√ß√µes carregadas:', CONFIG);
        return CONFIG;
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
        CONFIG = {
          paroquia: {
            nome: "Par√≥quia de S√£o Paulo de Luanda",
            secretariado: "Secretariado da Catequese",
            ano_catequetico: "2025/2026"
          },
          arquivos: {
            dados_principais: "data/dados-catequese.xlsx",
            logo: "assets/images/logo-paroquia.jpg"
          },
          validacao: {
            campos_obrigatorios: ["nome", "centro", "etapa", "sala", "horario", "catequistas", "resultado"]
          }
        };
        
        document.getElementById('logoImg').src = CONFIG.arquivos.logo;
        document.getElementById('paroquiaNome').textContent = CONFIG.paroquia.nome;
        document.getElementById('secretariado').textContent = CONFIG.paroquia.secretariado;
        document.getElementById('anoCatequetico').textContent = CONFIG.paroquia.ano_catequetico;
        document.getElementById('footerText').textContent = `¬© ${CONFIG.paroquia.nome} ‚Äî ${CONFIG.paroquia.secretariado}`;
        
        return CONFIG;
      }
    }

    // Carrega dados do Excel
    async function loadExcelData() {
      try {
        if (!CONFIG) throw new Error('Configura√ß√µes n√£o carregadas');
        
        const url = CONFIG.arquivos.dados_principais + '?v=' + Date.now();
        console.log('üîÑ Carregando Excel:', url);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Erro ao carregar Excel: ' + response.status);
        
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        
        if (!json.length) throw new Error('Excel vazio');
        
        const headers = json[0].map(String);
        const idx = mapHeaders(headers);
        const req = CONFIG.validacao?.campos_obrigatorios || ['nome', 'centro', 'etapa'];
        const missing = req.filter(k => !(k in idx));
        if (missing.length) throw new Error('Cabe√ßalhos ausentes: ' + missing.join(', '));

        const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
        dashboardData = rows.map(r => ({
          nome: r[idx.nome] ?? '',
          nascimento: r[idx.nascimento] ?? '',
          centro: r[idx.centro] ?? '',
          etapa: r[idx.etapa] ?? '',
          sala: r[idx.sala] ?? '',
          horario: r[idx.horario] ?? '',
          catequistas: r[idx.catequistas] ?? '',
          resultado: r[idx.resultado] ?? ''
        }));

        updateDashboard();
        console.log(`‚úÖ Dashboard atualizado com ${dashboardData.length} registos do Excel`);
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar Excel:', error);
        console.log('üîÑ Usando dados de exemplo como fallback');
        
        dashboardData = [...SAMPLE_DATA];
        updateDashboard();
      }
    }

    // Fun√ß√£o principal de atualiza√ß√£o do dashboard
    function updateDashboard() {
      if (!dashboardData) return;

      updateBasicStats();
      updateApprovalStats();
      updateAgeStats();
      updateDistributionCharts();
      updateRankingTable();
      updateApprovalByCategory();
      
      document.getElementById('lastUpdate').textContent = nowStamp();
    }

    // Estat√≠sticas b√°sicas
    function updateBasicStats() {
      const totalCatecumenos = dashboardData.length;
      const catequistasUnicos = new Set();
      const turmasUnicas = new Set();
      const centrosUnicos = new Set();
      const horariosUnicos = new Set();

      dashboardData.forEach(d => {
        if (d.catequistas) {
          d.catequistas.split('|').forEach(c => catequistasUnicos.add(c.trim()));
        }
        if (d.centro && d.etapa && d.sala && d.horario) {
          turmasUnicas.add(`${d.centro}-${d.etapa}-${d.sala}-${d.horario}`);
        }
        if (d.centro) centrosUnicos.add(d.centro);
        if (d.horario) horariosUnicos.add(d.horario);
      });

      document.getElementById('totalCatecumenos').textContent = formatNumber(totalCatecumenos);
      document.getElementById('totalCatequistas').textContent = formatNumber(catequistasUnicos.size);
      document.getElementById('totalTurmas').textContent = formatNumber(turmasUnicas.size);
      document.getElementById('totalCentros').textContent = formatNumber(centrosUnicos.size);
      document.getElementById('totalHorarios').textContent = formatNumber(horariosUnicos.size);
    } 
   // Estat√≠sticas de aprova√ß√£o
    function updateApprovalStats() {
      const totalWithResult = dashboardData.filter(d => d.resultado && d.resultado.trim()).length;
      const approved = dashboardData.filter(d => 
        d.resultado && norm(d.resultado).includes('aprovado')
      ).length;
      
      const approvalRate = totalWithResult > 0 ? (approved / totalWithResult * 100) : 0;
      
      document.getElementById('approvalRate').textContent = approvalRate.toFixed(1) + '%';
      
      const indicator = document.getElementById('approvalIndicator');
      if (approvalRate >= 80) {
        indicator.className = 'approval-indicator high';
      } else if (approvalRate >= 60) {
        indicator.className = 'approval-indicator medium';
      } else {
        indicator.className = 'approval-indicator low';
      }

      const details = document.getElementById('approvalDetails');
      details.innerHTML = `
        <div style="margin-top: 12px; font-size: 14px;">
          <div>‚úÖ Aprovados: <strong>${approved}</strong></div>
          <div>üìä Total avaliados: <strong>${totalWithResult}</strong></div>
          <div>üìã Total geral: <strong>${dashboardData.length}</strong></div>
        </div>
      `;
    }

    // Estat√≠sticas de idade
    function updateAgeStats() {
      const studentsWithAge = dashboardData
        .map(d => ({ ...d, age: calculateAge(d.nascimento) }))
        .filter(d => d.age !== null);

      if (studentsWithAge.length === 0) {
        document.getElementById('youngestStudent').innerHTML = '<div>Dados de idade n√£o dispon√≠veis</div>';
        document.getElementById('oldestStudent').innerHTML = '';
        return;
      }

      const youngest = studentsWithAge.reduce((min, student) => 
        student.age < min.age ? student : min
      );
      
      const oldest = studentsWithAge.reduce((max, student) => 
        student.age > max.age ? student : max
      );

      document.getElementById('youngestStudent').innerHTML = `
        <div style="margin-bottom: 16px;">
          <div class="age-badge young">Mais Novo</div>
          <div style="margin-top: 8px;">
            <strong>${youngest.nome}</strong><br>
            <span style="color: var(--muted);">${youngest.age} anos</span><br>
            <small>${youngest.centro} ‚Ä¢ ${youngest.etapa} ‚Ä¢ Sala ${youngest.sala}</small>
          </div>
        </div>
      `;

      document.getElementById('oldestStudent').innerHTML = `
        <div>
          <div class="age-badge old">Mais Velho</div>
          <div style="margin-top: 8px;">
            <strong>${oldest.nome}</strong><br>
            <span style="color: var(--muted);">${oldest.age} anos</span><br>
            <small>${oldest.centro} ‚Ä¢ ${oldest.etapa} ‚Ä¢ Sala ${oldest.sala}</small>
          </div>
        </div>
      `;
    }

    // Gr√°ficos de distribui√ß√£o
    function updateDistributionCharts() {
      // Distribui√ß√£o por Centro
      const centros = {};
      dashboardData.forEach(d => {
        if (d.centro) {
          centros[d.centro] = (centros[d.centro] || 0) + 1;
        }
      });

      const centroEntries = Object.entries(centros).sort(([,a], [,b]) => b - a);
      
      // Gr√°fico de Centro
      const centroCtx = document.getElementById('centroChart').getContext('2d');
      if (charts.centro) charts.centro.destroy();
      
      charts.centro = new Chart(centroCtx, {
        type: 'doughnut',
        data: {
          labels: centroEntries.map(([centro]) => centro),
          datasets: [{
            data: centroEntries.map(([,count]) => count),
            backgroundColor: [
              '#c28402', '#d39f21', '#16a34a', '#2563eb', '#dc2626', 
              '#7c3aed', '#ea580c', '#0891b2', '#be185d'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Estat√≠sticas de Centro
      const centroStatsHtml = centroEntries.map(([centro, count]) => {
        const percentage = ((count / dashboardData.length) * 100).toFixed(1);
        return `
          <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${centro}</span>
              <span>${count} (${percentage}%)</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('centroStats').innerHTML = centroStatsHtml;

      // Distribui√ß√£o por Etapa
      const etapas = {};
      dashboardData.forEach(d => {
        if (d.etapa) {
          etapas[d.etapa] = (etapas[d.etapa] || 0) + 1;
        }
      });

      const etapaEntries = Object.entries(etapas).sort(([a], [b]) => a.localeCompare(b));
      
      // Gr√°fico de Etapa
      const etapaCtx = document.getElementById('etapaChart').getContext('2d');
      if (charts.etapa) charts.etapa.destroy();
      
      charts.etapa = new Chart(etapaCtx, {
        type: 'bar',
        data: {
          labels: etapaEntries.map(([etapa]) => etapa),
          datasets: [{
            label: 'Catec√∫menos',
            data: etapaEntries.map(([,count]) => count),
            backgroundColor: '#c28402'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          animation: {
            onComplete: function() {
              const ctx = this.chart.ctx;
              ctx.font = '12px Arial';
              ctx.fillStyle = '#1b1a17';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              
              this.data.datasets.forEach((dataset, i) => {
                const meta = this.getDatasetMeta(i);
                meta.data.forEach((bar, index) => {
                  const data = dataset.data[index];
                  if (data > 0) {
                    ctx.fillText(data, bar.x, bar.y - 5);
                  }
                });
              });
            }
          }
        }
      });

      // Estat√≠sticas de Etapa
      const etapaStatsHtml = etapaEntries.map(([etapa, count]) => {
        const percentage = ((count / dashboardData.length) * 100).toFixed(1);
        return `
          <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${etapa}</span>
              <span>${count} (${percentage}%)</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('etapaStats').innerHTML = etapaStatsHtml;

      // Distribui√ß√£o por Hor√°rio
      const horarios = {};
      dashboardData.forEach(d => {
        if (d.horario) {
          horarios[d.horario] = (horarios[d.horario] || 0) + 1;
        }
      });

      const horarioStatsHtml = Object.entries(horarios)
        .sort(([,a], [,b]) => b - a)
        .map(([horario, count]) => {
          const percentage = ((count / dashboardData.length) * 100).toFixed(1);
          return `
            <div style="margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>${horario}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
      
      document.getElementById('horarioStats').innerHTML = horarioStatsHtml;

      // Catequistas por Centro
      updateCatequistasByCenter();
      
      // Turmas por Centro
      updateClassesByCenter();
    } 
   // Catequistas por Centro
    function updateCatequistasByCenter() {
      const catequistasPorCentro = {};
      
      dashboardData.forEach(d => {
        if (d.centro && d.catequistas) {
          if (!catequistasPorCentro[d.centro]) {
            catequistasPorCentro[d.centro] = new Set();
          }
          d.catequistas.split('|').forEach(c => {
            catequistasPorCentro[d.centro].add(c.trim());
          });
        }
      });

      const catequistasStatsHtml = Object.entries(catequistasPorCentro)
        .map(([centro, catequistasSet]) => ({
          centro,
          count: catequistasSet.size
        }))
        .sort((a, b) => b.count - a.count)
        .map(({ centro, count }) => `
          <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${centro}</span>
              <span>${count} catequistas</span>
            </div>
          </div>
        `).join('');
      
      document.getElementById('catequistasCentroStats').innerHTML = catequistasStatsHtml;
    }

    // Turmas por Centro
    function updateClassesByCenter() {
      const turmasPorCentro = {};
      
      dashboardData.forEach(d => {
        if (d.centro && d.etapa && d.sala && d.horario) {
          if (!turmasPorCentro[d.centro]) {
            turmasPorCentro[d.centro] = new Set();
          }
          turmasPorCentro[d.centro].add(`${d.etapa}-${d.sala}-${d.horario}`);
        }
      });

      const turmasStatsHtml = Object.entries(turmasPorCentro)
        .map(([centro, turmasSet]) => ({
          centro,
          count: turmasSet.size
        }))
        .sort((a, b) => b.count - a.count)
        .map(({ centro, count }) => `
          <div style="margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${centro}</span>
              <span>${count} turmas</span>
            </div>
          </div>
        `).join('');
      
      document.getElementById('turmasCentroStats').innerHTML = turmasStatsHtml;
    }

    // Tabela de ranking de turmas
    function updateRankingTable() {
      const turmas = new Map();
      
      dashboardData.forEach(d => {
        if (d.centro && d.etapa && d.sala && d.horario) {
          const key = `${d.centro}|${d.etapa}|${d.sala}|${d.horario}`;
          if (!turmas.has(key)) {
            turmas.set(key, {
              centro: d.centro,
              etapa: d.etapa,
              sala: d.sala,
              horario: d.horario,
              catequistas: new Set(),
              catecumenos: [],
              aprovados: 0
            });
          }
          
          const turma = turmas.get(key);
          turma.catecumenos.push(d);
          
          if (d.catequistas) {
            d.catequistas.split('|').forEach(c => {
              turma.catequistas.add(c.trim());
            });
          }
          
          if (d.resultado && norm(d.resultado).includes('aprovado')) {
            turma.aprovados++;
          }
        }
      });

      const rankingData = Array.from(turmas.values())
        .map(turma => ({
          ...turma,
          numCatequistas: turma.catequistas.size,
          numCatecumenos: turma.catecumenos.length,
          taxaAprovacao: turma.catecumenos.length > 0 ? 
            (turma.aprovados / turma.catecumenos.length * 100) : 0
        }))
        .sort((a, b) => b.numCatecumenos - a.numCatecumenos || b.taxaAprovacao - a.taxaAprovacao);

      const tbody = document.getElementById('rankingTableBody');
      tbody.innerHTML = rankingData.map((turma, index) => `
        <tr>
          <td>${index + 1}¬∫</td>
          <td>${turma.centro}</td>
          <td>${turma.etapa}</td>
          <td>${turma.sala}</td>
          <td>${turma.horario}</td>
          <td>${turma.numCatequistas}</td>
          <td><strong>${turma.numCatecumenos}</strong></td>
          <td>
            <div class="approval-rate">
              <div class="approval-indicator ${turma.taxaAprovacao >= 80 ? 'high' : turma.taxaAprovacao >= 60 ? 'medium' : 'low'}"></div>
              ${turma.taxaAprovacao.toFixed(1)}%
            </div>
          </td>
        </tr>
      `).join('');
    } 
   // Aprova√ß√£o por categoria
    function updateApprovalByCategory() {
      // Aprova√ß√£o por Centro
      const approvalByCentro = {};
      dashboardData.forEach(d => {
        if (d.centro && d.resultado) {
          if (!approvalByCentro[d.centro]) {
            approvalByCentro[d.centro] = { total: 0, aprovados: 0 };
          }
          approvalByCentro[d.centro].total++;
          if (norm(d.resultado).includes('aprovado')) {
            approvalByCentro[d.centro].aprovados++;
          }
        }
      });

      const approvalCentroHtml = Object.entries(approvalByCentro)
        .map(([centro, stats]) => {
          const rate = stats.total > 0 ? (stats.aprovados / stats.total * 100) : 0;
          return `
            <div class="approval-rate">
              <div class="approval-indicator ${rate >= 80 ? 'high' : rate >= 60 ? 'medium' : 'low'}"></div>
              <div>
                <strong>${centro}</strong><br>
                <span style="color: var(--muted);">${rate.toFixed(1)}% (${stats.aprovados}/${stats.total})</span>
              </div>
            </div>
          `;
        }).join('');
      
      document.getElementById('approvalCentroStats').innerHTML = approvalCentroHtml;

      // Aprova√ß√£o por Etapa
      const approvalByEtapa = {};
      dashboardData.forEach(d => {
        if (d.etapa && d.resultado) {
          if (!approvalByEtapa[d.etapa]) {
            approvalByEtapa[d.etapa] = { total: 0, aprovados: 0 };
          }
          approvalByEtapa[d.etapa].total++;
          if (norm(d.resultado).includes('aprovado')) {
            approvalByEtapa[d.etapa].aprovados++;
          }
        }
      });

      const approvalEtapaHtml = Object.entries(approvalByEtapa)
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([etapa, stats]) => {
          const rate = stats.total > 0 ? (stats.aprovados / stats.total * 100) : 0;
          return `
            <div class="approval-rate">
              <div class="approval-indicator ${rate >= 80 ? 'high' : rate >= 60 ? 'medium' : 'low'}"></div>
              <div>
                <strong>${etapa}</strong><br>
                <span style="color: var(--muted);">${rate.toFixed(1)}% (${stats.aprovados}/${stats.total})</span>
              </div>
            </div>
          `;
        }).join('');
      
      document.getElementById('approvalEtapaStats').innerHTML = approvalEtapaHtml;

      // Aprova√ß√£o por Hor√°rio
      const approvalByHorario = {};
      dashboardData.forEach(d => {
        if (d.horario && d.resultado) {
          if (!approvalByHorario[d.horario]) {
            approvalByHorario[d.horario] = { total: 0, aprovados: 0 };
          }
          approvalByHorario[d.horario].total++;
          if (norm(d.resultado).includes('aprovado')) {
            approvalByHorario[d.horario].aprovados++;
          }
        }
      });

      const approvalHorarioHtml = Object.entries(approvalByHorario)
        .map(([horario, stats]) => {
          const rate = stats.total > 0 ? (stats.aprovados / stats.total * 100) : 0;
          return `
            <div class="approval-rate">
              <div class="approval-indicator ${rate >= 80 ? 'high' : rate >= 60 ? 'medium' : 'low'}"></div>
              <div>
                <strong>${horario}</strong><br>
                <span style="color: var(--muted);">${rate.toFixed(1)}% (${stats.aprovados}/${stats.total})</span>
              </div>
            </div>
          `;
        }).join('');
      
      document.getElementById('approvalHorarioStats').innerHTML = approvalHorarioHtml;
    }  
  // Fun√ß√µes de exporta√ß√£o
    function exportCard(cardId, filename) {
      try {
        const cardElement = document.getElementById(cardId);
        if (!cardElement) {
          alert('Elemento n√£o encontrado para exporta√ß√£o');
          return;
        }

        // Extrai dados do card para Excel
        const data = extractCardData(cardId);
        if (!data || data.length === 0) {
          alert('Nenhum dado encontrado para exportar');
          return;
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Dados');
        XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        
        alert('Dados exportados com sucesso!');
      } catch (error) {
        alert('Erro ao exportar: ' + error.message);
      }
    }

    function exportChartAsPNG(elementId, filename) {
      try {
        const element = document.getElementById(elementId);
        if (!element) {
          alert('Elemento n√£o encontrado para exporta√ß√£o');
          return;
        }

        html2canvas(element, {
          backgroundColor: '#ffffff',
          scale: 2
        }).then(canvas => {
          const link = document.createElement('a');
          link.download = `${filename}_${new Date().toISOString().split('T')[0]}.png`;
          link.href = canvas.toDataURL();
          link.click();
          alert('Gr√°fico exportado como PNG!');
        }).catch(error => {
          alert('Erro ao exportar gr√°fico: ' + error.message);
        });
      } catch (error) {
        alert('Erro ao exportar: ' + error.message);
      }
    }

    function extractCardData(cardId) {
      switch (cardId) {
        case 'approvalCard':
          return [
            ['M√©trica', 'Valor'],
            ['Taxa de Aprova√ß√£o Geral', document.getElementById('approvalRate').textContent],
            ['Total de Catec√∫menos', dashboardData.length],
            ['Aprovados', dashboardData.filter(d => d.resultado && norm(d.resultado).includes('aprovado')).length]
          ];
        
        case 'ageCard':
          const studentsWithAge = dashboardData
            .map(d => ({ ...d, age: calculateAge(d.nascimento) }))
            .filter(d => d.age !== null);
          
          if (studentsWithAge.length === 0) return [['Dados de idade n√£o dispon√≠veis']];
          
          const youngest = studentsWithAge.reduce((min, s) => s.age < min.age ? s : min);
          const oldest = studentsWithAge.reduce((max, s) => s.age > max.age ? s : max);
          
          return [
            ['Categoria', 'Nome', 'Idade', 'Centro', 'Etapa', 'Sala'],
            ['Mais Novo', youngest.nome, youngest.age, youngest.centro, youngest.etapa, youngest.sala],
            ['Mais Velho', oldest.nome, oldest.age, oldest.centro, oldest.etapa, oldest.sala]
          ];
        
        case 'centroCard':
          const centros = {};
          dashboardData.forEach(d => {
            if (d.centro) centros[d.centro] = (centros[d.centro] || 0) + 1;
          });
          
          return [
            ['Centro', 'Catec√∫menos', 'Percentual'],
            ...Object.entries(centros).map(([centro, count]) => [
              centro, count, ((count / dashboardData.length) * 100).toFixed(1) + '%'
            ])
          ];
        
        case 'rankingCard':
          const table = document.getElementById('rankingTable');
          const data = [];
          
          // Cabe√ßalhos
          const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
          data.push(headers);
          
          // Dados
          Array.from(table.querySelectorAll('tbody tr')).forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
            data.push(rowData);
          });
          
          return data;
        
        default:
          return [['Dados n√£o dispon√≠veis para este card']];
      }
    }   
 // Fun√ß√µes de carregamento de dados
    function loadSampleData() {
      dashboardData = [...SAMPLE_DATA];
      updateDashboard();
      console.log('‚úÖ Dados de exemplo carregados no dashboard');
    }

    function loadExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
          
          if (!json.length) throw new Error('Excel vazio');
          
          const headers = json[0].map(String);
          const idx = mapHeaders(headers);
          const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
          
          dashboardData = rows.map(r => ({
            nome: r[idx.nome] ?? '',
            nascimento: r[idx.nascimento] ?? '',
            centro: r[idx.centro] ?? '',
            etapa: r[idx.etapa] ?? '',
            sala: r[idx.sala] ?? '',
            horario: r[idx.horario] ?? '',
            catequistas: r[idx.catequistas] ?? '',
            resultado: r[idx.resultado] ?? ''
          }));

          updateDashboard();
          console.log(`‚úÖ Dashboard atualizado com ${dashboardData.length} registos do Excel`);
          
        } catch (error) {
          console.error('‚ùå Erro ao carregar dados:', error);
          alert('Erro ao carregar dados: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Event listeners
    if (DEBUG_MODE) {
      document.getElementById('debugUpload').style.display = 'block';
      
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) loadExcelFile(file);
      });

      document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
    }

    document.getElementById('refreshBtn').addEventListener('click', () => {
      if (dashboardData) {
        updateDashboard();
        alert('Dashboard atualizado!');
      } else {
        alert('Carregue dados primeiro');
      }
    });
    
    document.getElementById('exportAllBtn').addEventListener('click', () => {
      if (!dashboardData) {
        alert('Nenhum dado carregado para exportar');
        return;
      }
      
      try {
        const wb = XLSX.utils.book_new();
        
        // Dados principais
        const ws1 = XLSX.utils.json_to_sheet(dashboardData);
        XLSX.utils.book_append_sheet(wb, ws1, 'Dados Completos');
        
        // Estat√≠sticas resumidas
        const stats = [
          ['Estat√≠stica', 'Valor'],
          ['Total de Catec√∫menos', dashboardData.length],
          ['Total de Catequistas', new Set(dashboardData.flatMap(d => d.catequistas ? d.catequistas.split('|').map(c => c.trim()) : [])).size],
          ['Total de Centros', new Set(dashboardData.map(d => d.centro).filter(Boolean)).size],
          ['Taxa de Aprova√ß√£o', document.getElementById('approvalRate').textContent]
        ];
        
        const ws2 = XLSX.utils.aoa_to_sheet(stats);
        XLSX.utils.book_append_sheet(wb, ws2, 'Estat√≠sticas');
        
        XLSX.writeFile(wb, `dashboard_completo_${new Date().toISOString().split('T')[0]}.xlsx`);
        alert('Dashboard completo exportado!');
      } catch (error) {
        alert('Erro ao exportar: ' + error.message);
      }
    });

    document.getElementById('printDashboard').addEventListener('click', () => {
      window.print();
    });

    // Inicializa√ß√£o
    async function init() {
      try {
        await loadConfig();
        await loadExcelData();
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>