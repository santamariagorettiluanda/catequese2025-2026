<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî Par√≥quia de S√£o Paulo de Luanda</title>
  
  <!-- SheetJS -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --bg: #fffdf6; --card: #ffffff; --ink: #1b1a17; --muted: #6b7280;
      --accent: #c28402; --accent-2: #d39f21; --ok: #16a34a; --warn: #b45309;
      --border: #ecd39a; --border-light: #f0e1b6; --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card {
      width: 100%; background: var(--card); border-radius: var(--radius);
      box-shadow: -1px 9px 8px rgba(0,0,0,0.08); margin-bottom: 16px;
    }
    .hero-brand {
      width: 100%; padding: 16px; display: flex; gap: 16px; align-items: center;
    }
    .hero-brand img {
      width: 72px; height: auto; border-radius: 12px;
      border: 1px solid var(--border); background: #fff; padding: 4px;
    }
    .title { font-weight: 800; font-size: 18px; }
    .subtitle { font-weight: 700; color: var(--muted); }
    .info { margin-top: 6px; font-weight: 800; font-size: 16px; }
    .meta { color: #374151; margin-top: 2px; font-size: 14px; }
    
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 16px; }
    .btn {
      background: var(--accent); color: #fff; border: 0; padding: 10px 14px;
      border-radius: 10px; font-weight: 700; cursor: pointer; text-decoration: none;
      display: inline-block;
    }
    .btn.secondary { background: #fff; color: var(--accent); border: 1px solid var(--accent); }
    .btn:hover { background: var(--accent-2); }
    .btn.secondary:hover { background: var(--accent); color: #fff; }
    
    .debug-upload {
      margin: 16px 0; padding: 16px; border: 2px dashed #dc2626;
      border-radius: 12px; text-align: center; background: #fef2f2;
      color: #991b1b;
    }
    .debug-upload input[type="file"] { margin: 8px 0; }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .dashboard-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: -1px 9px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }
    
    .dashboard-card h3 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 18px;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--accent);
      margin: 8px 0;
    }
    
    .stat-label {
      color: var(--muted);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .quick-actions .btn {
      justify-content: flex-start;
      text-decoration: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    
    .recent-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .recent-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .recent-list li:last-child {
      border-bottom: none;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-indicator.success { background: var(--ok); }
    .status-indicator.warning { background: var(--warn); }
    .status-indicator.error { background: #dc2626; }
    
    .footer { color: var(--muted); font-size: 12px; text-align: center; margin: 24px 0; }
  </style>
</head>
<body>
  <header class="card">
    <div class="container">
      <div class="hero-brand card">
        <img id="logoImg" alt="Logo da Par√≥quia" onerror="this.style.display='none'"/>
        <div>
          <div class="title" id="paroquiaNome">A carregar...</div>
          <div class="subtitle" id="secretariado">A carregar...</div>
          <div class="info">Dashboard da Catequese</div>
          <div class="meta">Ano Catequ√©tico: <strong id="anoCatequetico">A carregar...</strong></div>
        </div>
      </div>

      <!-- Debug Mode: File Upload (s√≥ aparece se DEBUG_MODE = true) -->
      <div id="debugUpload" class="debug-upload" style="display:none">
        <div><strong>üîß MODO DEBUG ATIVO</strong></div>
        <div>Carregar arquivo Excel para testes:</div>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <button class="btn" id="loadSampleBtn">üìä Usar Dados de Exemplo</button>
      </div>

      <div class="actions">
        <a href="index.html" class="btn">üìã Lista de Catec√∫menos</a>
        <a href="lista-catequistas.html" class="btn secondary">üë• Lista de Catequistas</a>
        <button class="btn secondary" id="refreshBtn">üîÑ Atualizar Dados</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="dashboard-grid">
      <!-- Estat√≠sticas Gerais -->
      <div class="dashboard-card">
        <h3>üìä Estat√≠sticas Gerais</h3>
        <div class="stat-number" id="totalCatecumenos">-</div>
        <div class="stat-label">Total de Catec√∫menos</div>
        
        <div style="margin-top: 16px;">
          <div class="stat-number" style="font-size: 1.5rem;" id="totalCatequistas">-</div>
          <div class="stat-label">Catequistas Ativos</div>
        </div>
        
        <div style="margin-top: 16px;">
          <div class="stat-number" style="font-size: 1.5rem;" id="totalTurmas">-</div>
          <div class="stat-label">Turmas Formadas</div>
        </div>
      </div>

      <!-- Distribui√ß√£o por Centro -->
      <div class="dashboard-card">
        <h3>üè¢ Distribui√ß√£o por Centro</h3>
        <div id="centrosStats">Carregue dados para ver estat√≠sticas</div>
      </div>

      <!-- Distribui√ß√£o por Etapa -->
      <div class="dashboard-card">
        <h3>üìö Distribui√ß√£o por Etapa</h3>
        <div id="etapasStats">Carregue dados para ver estat√≠sticas</div>
      </div>

      <!-- Resultados -->
      <div class="dashboard-card">
        <h3>üìà Resultados</h3>
        <div id="resultadosStats">Carregue dados para ver estat√≠sticas</div>
      </div>

      <!-- A√ß√µes R√°pidas -->
      <div class="dashboard-card">
        <h3>‚ö° A√ß√µes R√°pidas</h3>
        <div class="quick-actions">
          <a href="index.html" class="btn secondary">üìã Ver Lista Completa</a>
          <a href="lista-catequistas.html" class="btn secondary">üë• Gerir Catequistas</a>
          <button class="btn secondary" id="exportAllBtn">üìä Exportar Relat√≥rio</button>
          <button class="btn secondary" id="backupBtn">üíæ Fazer Backup</button>
        </div>
      </div>

      <!-- Informa√ß√µes do Sistema -->
      <div class="dashboard-card">
        <h3>‚ÑπÔ∏è Informa√ß√µes do Sistema</h3>
        <ul class="recent-list">
          <li>
            <span>√öltima atualiza√ß√£o</span>
            <span id="lastUpdate">-</span>
          </li>
          <li>
            <span>Vers√£o dos dados</span>
            <span id="dataVersion">-</span>
          </li>
          <li>
            <span>Estado do sistema</span>
            <span><span class="status-indicator success"></span>Online</span>
          </li>
        </ul>
      </div>
    </div>
  </main>

  <div class="footer" id="footerText">¬© Par√≥quia de S√£o Paulo de Luanda ‚Äî Secretariado da Catequese</div>

  <script>
    // üîß DEBUG MODE: Altere para true para mostrar op√ß√£o de upload de arquivo
    const DEBUG_MODE = false;
    
    let CONFIG = null;

    // Dados de exemplo
    const SAMPLE_DATA = [
      {
        nome: "Jo√£o Silva Santos",
        nascimento: "15/03/2010",
        centro: "Centro Principal",
        etapa: "1¬™ Etapa",
        sala: "101",
        horario: "S√°bado Manh√£",
        catequistas: "Maria Jos√©|Pedro Costa",
        resultado: "Aprovado"
      },
      {
        nome: "Ana Maria Fernandes",
        nascimento: "22/07/2009",
        centro: "Centro Norte",
        etapa: "2¬™ Etapa",
        sala: "205",
        horario: "Domingo Tarde",
        catequistas: "Carlos Silva",
        resultado: "Aprovado"
      },
      {
        nome: "Miguel Ant√≥nio Lopes",
        nascimento: "08/11/2011",
        centro: "Centro Sul",
        etapa: "1¬™ Etapa",
        sala: "102",
        horario: "S√°bado Tarde",
        catequistas: "Isabel Santos|Jo√£o Pereira",
        resultado: "Em Avalia√ß√£o"
      },
      {
        nome: "Beatriz Costa Rodrigues",
        nascimento: "14/05/2008",
        centro: "Centro Principal",
        etapa: "3¬™ Etapa",
        sala: "301",
        horario: "Domingo Manh√£",
        catequistas: "Ant√≥nio Silva",
        resultado: "Aprovado"
      },
      {
        nome: "Francisco Manuel Sousa",
        nascimento: "30/09/2010",
        centro: "Centro Norte",
        etapa: "2¬™ Etapa",
        sala: "203",
        horario: "S√°bado Manh√£",
        catequistas: "Teresa Lopes|Manuel Costa",
        resultado: "Reprovado"
      },
      {
        nome: "Lu√≠sa Pereira Gomes",
        nascimento: "12/01/2009",
        centro: "Centro Sul",
        etapa: "2¬™ Etapa",
        sala: "204",
        horario: "Domingo Tarde",
        catequistas: "Fernanda Lima",
        resultado: "Aprovado"
      }
    ];

    let dashboardData = null;
    
    // Utilit√°rios
    const norm = (s) => (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
    const fmtDate = (s) => {
      if (!s) return '';
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
      const d = new Date(s);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return s;
    };
    const formatNumber = (num) => new Intl.NumberFormat('pt-AO').format(num);
    const nowStamp = () => {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    };
    
    function mapHeaders(cols) {
      const wanted = {
        nome: ['nome', 'nomecompleto'],
        nascimento: ['nascimento', 'datanascimento', 'data', 'dn'],
        centro: ['centro', 'centrodecatequese', 'paroquia', 'comunidade'],
        etapa: ['etapa', 'etapacatequese', 'nivel', 'ano', 'classe'],
        sala: ['sala', 'numerosala', 'turma', 'salaaula'],
        horario: ['horario', 'hora', 'turno', 'periodo', 'diaehora', 'diahora'],
        catequistas: ['catequistas', 'catequista', 'responsaveis', 'responsavel'],
        resultado: ['resultado', 'situacao', 'status']
      };
      const idx = {};
      cols.forEach((c, i) => {
        const k = norm(c).replace(/[^a-z0-9]/g, '');
        for (const [t, aliases] of Object.entries(wanted)) {
          if (aliases.includes(k)) idx[t] = i;
        }
      });
      return idx;
    }

    // Carrega configura√ß√µes do arquivo settings.json
    async function loadConfig() {
      try {
        const response = await fetch('config/settings.json?v=' + Date.now());
        if (!response.ok) throw new Error('Erro ao carregar configura√ß√µes: ' + response.status);
        CONFIG = await response.json();
        
        // Atualiza interface com configura√ß√µes
        document.getElementById('logoImg').src = CONFIG.arquivos.logo;
        document.getElementById('paroquiaNome').textContent = CONFIG.paroquia.nome;
        document.getElementById('secretariado').textContent = CONFIG.paroquia.secretariado;
        document.getElementById('anoCatequetico').textContent = CONFIG.paroquia.ano_catequetico;
        document.getElementById('footerText').textContent = `¬© ${CONFIG.paroquia.nome} ‚Äî ${CONFIG.paroquia.secretariado}`;
        
        console.log('‚úÖ Configura√ß√µes carregadas:', CONFIG);
        return CONFIG;
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
        // Valores padr√£o em caso de erro
        CONFIG = {
          paroquia: {
            nome: "Par√≥quia de S√£o Paulo de Luanda",
            secretariado: "Secretariado da Catequese",
            ano_catequetico: "2025/2026"
          },
          arquivos: {
            dados_principais: "data/dados-catequese.xlsx",
            logo: "assets/images/logo-paroquia.jpg"
          },
          validacao: {
            campos_obrigatorios: ["nome", "centro", "etapa", "sala", "horario", "catequistas", "resultado"]
          }
        };
        
        // Atualiza interface com valores padr√£o
        document.getElementById('logoImg').src = CONFIG.arquivos.logo;
        document.getElementById('paroquiaNome').textContent = CONFIG.paroquia.nome;
        document.getElementById('secretariado').textContent = CONFIG.paroquia.secretariado;
        document.getElementById('anoCatequetico').textContent = CONFIG.paroquia.ano_catequetico;
        document.getElementById('footerText').textContent = `¬© ${CONFIG.paroquia.nome} ‚Äî ${CONFIG.paroquia.secretariado}`;
        
        return CONFIG;
      }
    }

    // Carrega dados do Excel usando o caminho configurado
    async function loadExcelData() {
      try {
        if (!CONFIG) throw new Error('Configura√ß√µes n√£o carregadas');
        
        const url = CONFIG.arquivos.dados_principais + '?v=' + Date.now();
        console.log('üîÑ Carregando Excel:', url);
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Erro ao carregar Excel: ' + response.status);
        
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        
        if (!json.length) throw new Error('Excel vazio');
        
        const headers = json[0].map(String);
        const idx = mapHeaders(headers);
        const req = CONFIG.validacao?.campos_obrigatorios || ['nome', 'centro', 'etapa'];
        const missing = req.filter(k => !(k in idx));
        if (missing.length) throw new Error('Cabe√ßalhos ausentes: ' + missing.join(', '));

        const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
        dashboardData = rows.map(r => ({
          nome: r[idx.nome] ?? '',
          nascimento: r[idx.nascimento] ?? '',
          centro: r[idx.centro] ?? '',
          etapa: r[idx.etapa] ?? '',
          sala: r[idx.sala] ?? '',
          horario: r[idx.horario] ?? '',
          catequistas: r[idx.catequistas] ?? '',
          resultado: r[idx.resultado] ?? ''
        }));

        updateDashboard();
        console.log(`‚úÖ Dashboard atualizado com ${dashboardData.length} registos do Excel`);
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar Excel:', error);
        console.log('üîÑ Usando dados de exemplo como fallback');
        
        // Usa dados de exemplo como fallback
        dashboardData = [...SAMPLE_DATA];
        updateDashboard();
      }
    }

    // Atualiza√ß√£o do dashboard
    function updateDashboard() {
      if (!dashboardData) return;

      // Estat√≠sticas gerais
      const totalCatecumenos = dashboardData.length;
      const catequistasUnicos = new Set();
      const turmasUnicas = new Set();

      dashboardData.forEach(d => {
        if (d.catequistas) {
          d.catequistas.split('|').forEach(c => catequistasUnicos.add(c.trim()));
        }
        if (d.centro && d.etapa && d.sala && d.horario) {
          turmasUnicas.add(`${d.centro}-${d.etapa}-${d.sala}-${d.horario}`);
        }
      });

      document.getElementById('totalCatecumenos').textContent = formatNumber(totalCatecumenos);
      document.getElementById('totalCatequistas').textContent = formatNumber(catequistasUnicos.size);
      document.getElementById('totalTurmas').textContent = formatNumber(turmasUnicas.size);

      // Distribui√ß√£o por centro
      const centros = {};
      dashboardData.forEach(d => {
        if (d.centro) {
          centros[d.centro] = (centros[d.centro] || 0) + 1;
        }
      });

      const centrosHtml = Object.entries(centros)
        .sort(([,a], [,b]) => b - a)
        .map(([centro, count]) => {
          const percentage = ((count / totalCatecumenos) * 100).toFixed(1);
          return `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>${centro}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');

      document.getElementById('centrosStats').innerHTML = centrosHtml;

      // Distribui√ß√£o por etapa
      const etapas = {};
      dashboardData.forEach(d => {
        if (d.etapa) {
          etapas[d.etapa] = (etapas[d.etapa] || 0) + 1;
        }
      });

      const etapasHtml = Object.entries(etapas)
        .sort(([a], [b]) => a.localeCompare(b))
        .map(([etapa, count]) => {
          const percentage = ((count / totalCatecumenos) * 100).toFixed(1);
          return `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>${etapa}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');

      document.getElementById('etapasStats').innerHTML = etapasHtml;

      // Distribui√ß√£o por resultado
      const resultados = {};
      dashboardData.forEach(d => {
        if (d.resultado) {
          resultados[d.resultado] = (resultados[d.resultado] || 0) + 1;
        }
      });

      const resultadosHtml = Object.entries(resultados)
        .sort(([,a], [,b]) => b - a)
        .map(([resultado, count]) => {
          const percentage = ((count / totalCatecumenos) * 100).toFixed(1);
          return `
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>${resultado}</span>
                <span>${count} (${percentage}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');

      document.getElementById('resultadosStats').innerHTML = resultadosHtml;

      // Informa√ß√µes do sistema
      document.getElementById('lastUpdate').textContent = nowStamp();
      document.getElementById('dataVersion').textContent = new Date().toISOString().split('T')[0];
    }

    function loadSampleData() {
      dashboardData = [...SAMPLE_DATA];
      updateDashboard();
      console.log('‚úÖ Dados de exemplo carregados no dashboard');
    }

    function loadExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
          
          if (!json.length) throw new Error('Excel vazio');
          
          const headers = json[0].map(String);
          const idx = mapHeaders(headers);
          const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
          
          dashboardData = rows.map(r => ({
            nome: r[idx.nome] ?? '',
            nascimento: r[idx.nascimento] ?? '',
            centro: r[idx.centro] ?? '',
            etapa: r[idx.etapa] ?? '',
            sala: r[idx.sala] ?? '',
            horario: r[idx.horario] ?? '',
            catequistas: r[idx.catequistas] ?? '',
            resultado: r[idx.resultado] ?? ''
          }));

          updateDashboard();
          console.log(`‚úÖ Dashboard atualizado com ${dashboardData.length} registos do Excel`);
          
        } catch (error) {
          console.error('‚ùå Erro ao carregar dados:', error);
          alert('Erro ao carregar dados: ' + error.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Event listeners para modo debug
    if (DEBUG_MODE) {
      document.getElementById('debugUpload').style.display = 'block';
      
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          loadExcelFile(file);
        }
      });

      document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
    }
    document.getElementById('refreshBtn').addEventListener('click', () => {
      if (dashboardData) {
        updateDashboard();
        alert('Dashboard atualizado!');
      } else {
        alert('Carregue dados primeiro');
      }
    });
    
    document.getElementById('exportAllBtn').addEventListener('click', async () => {
      if (!dashboardData) {
        alert('Nenhum dado carregado para exportar');
        return;
      }
      
      try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dashboardData);
        XLSX.utils.book_append_sheet(wb, ws, 'Dados Completos');
        XLSX.writeFile(wb, `relatorio_catequese_${new Date().toISOString().split('T')[0]}.xlsx`);
        alert('Relat√≥rio exportado com sucesso!');
      } catch (error) {
        alert('Erro ao exportar relat√≥rio: ' + error.message);
      }
    });

    document.getElementById('backupBtn').addEventListener('click', () => {
      if (!dashboardData) {
        alert('Nenhum dado carregado para backup');
        return;
      }
      
      try {
        const timestamp = nowStamp().replace(/[/:]/g, '-');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dashboardData);
        XLSX.utils.book_append_sheet(wb, ws, 'Backup');
        XLSX.writeFile(wb, `backup_catequese_${timestamp}.xlsx`);
        alert('Backup criado com sucesso!');
      } catch (error) {
        alert('Erro ao criar backup: ' + error.message);
      }
    });

    // Inicializa√ß√£o
    async function init() {
      try {
        await loadConfig();
        await loadExcelData();
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
      }
    }

    // Inicia quando a p√°gina carrega
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>