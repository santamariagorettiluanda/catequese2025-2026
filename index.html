<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Salas ‚Äî Par√≥quia de S√£o Paulo de Luanda</title>
  <!-- SheetJS para ler .xlsx via fetch -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#fffdf6; --card:#ffffff; --ink:#1b1a17; --muted:#6b7280;
      --accent:#c28402; --accent-2:#d39f21; --ok:#16a34a; --warn:#b45309; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{position:static; background:transparent; border:0;}
    .card{background:var(--card); border:1px solid #ecd39a; border-radius:var(--radius); box-shadow:0 2px 10px rgba(0,0,0,0.04)}
    .hero-brand{margin-top:0; padding:18px; display:flex; gap:16px; align-items:center}
    .hero-brand img{width:72px; height:auto; border-radius:12px; border:1px solid #ecd39a; background:#fff; padding:4px}
    .searchbar{display:flex;gap:10px; padding:12px}
    .field{ position:relative; flex:1; }
    .field input[type="search"]{ width:100%; padding:14px 44px; border-radius:12px; border:1px solid #d1b35e; outline:none; font-size:16px; background:#fff; }
    .field input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(194,132,2,0.15) }
    .field .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:20px; color:var(--muted)}
    .clear-btn{ position:absolute; right:10px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:18px; color:var(--muted); }
    .filters{ display:flex; flex-wrap:wrap; gap:8px; padding:0 12px 12px }
    .filters select{ border:1px solid #d1b35e; border-radius:10px; padding:10px 12px; background:#fff; font-size:14px; }
    .stats{padding:10px 14px; color:var(--muted); font-size:14px}
    .results{ margin-top:16px; }
    .row{ display:grid; grid-template-columns: 1.2fr 0.8fr 0.7fr 0.5fr 0.6fr; gap:12px; align-items:center; padding:14px 14px; border-bottom:1px dashed #f0e1b6; }
    .row:nth-child(odd){ background: #fff9e9 }
    .row.header{ font-weight:700; color:#111; background:#ffeab9; border-top-left-radius:12px; border-top-right-radius:12px; border-bottom:1px solid #f0e1b6 }
    .center{color:#7a4d00; font-weight:600}
    .badge{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #d1b35e; font-size:12px; background:#fff }
    mark{ background: #fff2a8; padding:0 2px; border-radius:3px }
    .footer{color:var(--muted); font-size:12px; text-align:center; margin:24px 0}
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{ background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer }
    .btn.secondary{ background:#fff; color:var(--accent); border:1px solid var(--accent) }
    .hide{ display:none !important }
    .hint{ font-size:12px; color:var(--muted); padding:0 12px 12px }
    .alert{ margin:12px; padding:12px; border-radius:10px; border:1px solid #f59e0b; background:#fff7ed; color:#7c2d12; }
    @media (max-width:800px){
      .row{ grid-template-columns: 1fr; gap:6px }
      .row.header{ display:none }
      .row > div{ display:flex; gap:8px }
      .row > div::before{ content: attr(data-label); min-width:110px; color:var(--muted) }
      .searchbar{ flex-direction:column }
      .filters{ gap:6px }
      .actions{ width:100% }
      .actions .btn{ flex:1 }
    }
  </style>
</head>
<body>
  <header class="card">
    <div class="container">
      <div class="hero-brand card">
        <!-- opcional: coloque um ficheiro logo-paroquia.jpg ao lado do HTML -->
        <img id="logo" alt="Par√≥quia de S√£o Paulo de Luanda" />
        <div>
          <div style="font-weight:800; font-size:18px">Par√≥quia de S√£o Paulo de Luanda</div>
          <div style="font-weight:700; color:#6b7280">Secretariado da Catequese</div>
          <div style="margin-top:6px; font-weight:800; font-size:16px">Lista Final da Catequese 2025/2026</div>
          <div style="color:#374151; margin-top:2px">Data de In√≠cio da Catequese: <strong>1 de Outubro de 2025</strong></div>
        </div>
      </div>

      <div class="searchbar">
        <div class="field">
          <span class="icon">üîé</span>
          <input id="q" type="search" inputmode="search" placeholder="Digite seu nome completo..." autocomplete="off" />
          <button class="clear-btn" id="clearBtn" title="Limpar">‚úï</button>
        </div>
        <div class="actions">
          <button class="btn" id="shareBtn" title="Copiar link com a pesquisa">Compartilhar pesquisa</button>
          <button class="btn secondary" id="printBtn" title="Imprimir listagem">Imprimir</button>
        </div>
      </div>

      <div class="filters">
        <select id="centroFilter"><option value="">Centro (todos)</option></select>
        <select id="etapaFilter"><option value="">Etapa (todas)</option></select>
        <select id="horarioFilter"><option value="">Hor√°rio (todos)</option></select>
      </div>

      <div class="hint">Dados carregados do ficheiro <b>dados-catequese.xlsx</b> (1¬™ folha). Atualize-o no servidor para refletir mudan√ßas.</div>
      <div id="warn" class="alert" style="display:none">
        N√£o foi poss√≠vel carregar o Excel. Se estiver a ver dentro do WhatsApp, toque em <b>‚ÄúAbrir no navegador‚Äù</b>.
        Confirme que <code>dados-catequese.xlsx</code> est√° na mesma pasta do HTML.
      </div>
      <div class="stats" id="stats">A carregar‚Ä¶</div>
    </div>
  </header>

  <main class="container">
    <div class="card results" id="results"></div>
  </main>

  <div class="footer">¬© Par√≥quia de S√£o Paulo de Luanda ‚Äî Secretariado da Catequese</div>

  <script>
    // Ajuste aqui se mudar o nome do ficheiro
    const EXCEL_PATH = 'dados-catequese.xlsx';
    const LOGO_FILE = 'logo-paroquia.jpg'; // opcional

    const norm = (s) => (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const fmtDate = (s) => {
      if(!s) return '';
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
      const d = new Date(s);
      if(!isNaN(d)) { const dd = String(d.getDate()).padStart(2,'0'); const mm = String(d.getMonth()+1).padStart(2,'0'); const yy = d.getFullYear(); return `${dd}/${mm}/${yy}`; }
      const m = s.match(/^(\d{1,2})[-.](\d{1,2})[-.](\d{4})$/);
      if(m){ const dd = m[1].padStart(2,'0'); const mm = m[2].padStart(2,'0'); return `${dd}/${mm}/${m[3]}`; }
      return s;
    };

    function uniq(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt')); }
    function mapHeaders(cols){
      const wanted = {
        nome: ['nome','nomecompleto'],
        nascimento: ['nascimento','datanascimento','data','dn'],
        centro: ['centro','centrodecatequese','paroquia','comunidade'],
        etapa: ['etapa','etapacatequese','nivel','ano','classe'],
        sala: ['sala','numerosala','turma','salaaula'],
        horario: ['horario','hora','turno','periodo','diaehora','diahora'],
      };
      const key = (s)=>norm(s).replace(/[^a-z0-9]/g,'');
      const idx = {};
      cols.forEach((c,i)=>{ const k = key(c); for(const [t,aliases] of Object.entries(wanted)){ if(aliases.includes(k)) idx[t]=i; } });
      return idx;
    }

    function render(list){
      const results = document.getElementById('results');
      const stats = document.getElementById('stats');
      const q = document.getElementById('q');
      results.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'row header';
      header.innerHTML = `<div>Nome</div><div>Centro</div><div>Etapa</div><div>Sala</div><div>Hor√°rio</div>`;
      results.appendChild(header);
      const frag = document.createDocumentFragment();
      for(const d of list){
        const row = document.createElement('div');
        row.className='row';
        const nq = norm(q.value);
        const idx = norm(d.nome).indexOf(nq);
        const nomeHTML = (idx>=0 && nq) ? d.nome.slice(0,idx)+'<mark>'+d.nome.slice(idx,idx+nq.length)+'</mark>'+d.nome.slice(idx+nq.length) : d.nome;
        row.innerHTML = `
          <div data-label="Nome">${nomeHTML}<div class="subtitle">Nascimento: ${d.nascimento_fmt || '-'}</div></div>
          <div data-label="Centro" class="center">${d.centro}</div>
          <div data-label="Etapa"><span class="badge">${d.etapa}</span></div>
          <div data-label="Sala"><span class="badge">${d.sala}</span></div>
          <div data-label="Hor√°rio">${d.horario}</div>`;
        frag.appendChild(row);
      }
      results.appendChild(frag);
      stats.textContent = list.length + ' resultado' + (list.length===1?'':'s');
    }

    async function loadLogo(){
      const img = document.getElementById('logo');
      try{
        const res = await fetch(LOGO_FILE, {method:'HEAD'});
        if(res.ok) img.src = LOGO_FILE; else img.style.display='none';
      }catch(_){ img.style.display='none'; }
    }

    async function loadExcel(){
      const warn = document.getElementById('warn');
      const stats = document.getElementById('stats');
      try{
        const res = await fetch(EXCEL_PATH + '?v=' + Date.now());
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        if(!json.length) throw new Error('Planilha vazia');
        const headers = json[0].map(String);
        const idx = mapHeaders(headers);
        const req = ['nome','nascimento','centro','etapa','sala','horario'];
        const missing = req.filter(k => !(k in idx));
        if(missing.length) throw new Error('Cabe√ßalho inv√°lido: ' + headers.join(', '));
        const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
        window.__CATEQUESE_DATA__ = rows.map(r => ({
          nome: r[idx.nome] ?? '',
          nascimento: r[idx.nascimento] ?? '',
          centro: r[idx.centro] ?? '',
          etapa: r[idx.etapa] ?? '',
          sala: r[idx.sala] ?? '',
          horario: r[idx.horario] ?? ''
        }));
        window.__CATEQUESE_DATA__.forEach(d => d.nascimento_fmt = fmtDate(d.nascimento));
        buildUI();
      }catch(e){
        console.error(e);
        warn.style.display = '';
        stats.textContent = 'Falha ao carregar os dados.';
      }
    }

    function buildUI(){
      const q = document.getElementById('q');
      const centroFilter = document.getElementById('centroFilter');
      const etapaFilter = document.getElementById('etapaFilter');
      const horarioFilter = document.getElementById('horarioFilter');
      const shareBtn = document.getElementById('shareBtn');
      const printBtn = document.getElementById('printBtn');
      const clearBtn = document.getElementById('clearBtn');

      function populateFilters(){
        centroFilter.innerHTML = '<option value="">Centro (todos)</option>';
        etapaFilter.innerHTML = '<option value="">Etapa (todas)</option>';
        horarioFilter.innerHTML = '<option value="">Hor√°rio (todos)</option>';
        for(const c of uniq(window.__CATEQUESE_DATA__.map(d=>d.centro))){ const o=document.createElement('option'); o.value=c; o.textContent=c; centroFilter.appendChild(o); }
        for(const e of uniq(window.__CATEQUESE_DATA__.map(d=>d.etapa))){ const o=document.createElement('option'); o.value=e; o.textContent=e; etapaFilter.appendChild(o); }
        for(const h of uniq(window.__CATEQUESE_DATA__.map(d=>d.horario))){ const o=document.createElement('option'); o.value=h; o.textContent=h; horarioFilter.appendChild(o); }
      }

      function applySearch(){
        const nq = norm(q.value);
        const fCentro = centroFilter.value;
        const fEtapa = etapaFilter.value;
        const fHorario = horarioFilter.value;
        let list = window.__CATEQUESE_DATA__;
        if(fCentro) list = list.filter(d => d.centro === fCentro);
        if(fEtapa) list = list.filter(d => d.etapa === fEtapa);
        if(fHorario) list = list.filter(d => d.horario === fHorario);
        if(nq) list = list.filter(d => norm(d.nome).includes(nq));
        render(list);
      }

      let t;
      q.addEventListener('input', () => { clearTimeout(t); t = setTimeout(applySearch, 80); });
      clearBtn.addEventListener('click', () => { q.value=''; applySearch(); q.focus(); });
      printBtn.addEventListener('click', () => window.print());
      shareBtn.addEventListener('click', async () => {
        try{ await navigator.clipboard.writeText(location.href); shareBtn.textContent='Link copiado!'; setTimeout(()=>shareBtn.textContent='Compartilhar pesquisa',1500);}catch(e){ alert('Copie o link da barra de endere√ßos para compartilhar.'); }
      });
      centroFilter.addEventListener('change', applySearch);
      etapaFilter.addEventListener('change', applySearch);
      horarioFilter.addEventListener('change', applySearch);

      populateFilters();
      applySearch();
    }

    loadLogo();
    loadExcel();
  </script>
</body>
</html>
