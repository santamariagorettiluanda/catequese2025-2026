<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catequistas — Paróquia de São Paulo de Luanda</title>

  <!-- SheetJS (UMD compatível com iOS) -->
  <script defer src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#fffdf6; --card:#ffffff; --ink:#1b1a17; --muted:#6b7280;
      --accent:#c28402; --accent-2:#d39f21; --ok:#16a34a; --warn:#b45309; --radius:16px;
      --border:#ecd39a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:static;background:transparent;border:0;}
    .card{width:100%;background:var(--card);box-shadow:-1px 9px 8px rgba(0,0,0,.08)}
    .hero-brand{width:100%;padding:16px;display:flex;gap:16px;align-items:center}
    .hero-brand img{width:72px;height:auto;border-radius:12px;border:1px solid var(--border);background:#fff;padding:4px}

    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .filters select,.filters input[type="search"]{
      border:1px solid #d1b35e;border-radius:10px;padding:10px 12px;background:#fff;font-size:16px
    }
    .filters .sala-field{min-width:120px;flex:0 0 160px}
    .filters .cateq-field{min-width:200px;flex:1}

    .stats{padding:8px 4px;color:var(--muted);font-size:14px}
    .results{margin-top:8px;width:100%;overflow-x:hidden}
    .row{
      display:grid;
      grid-template-columns:1.3fr 0.9fr 0.8fr 0.5fr 0.7fr 0.5fr; /* Catequista, Centro, Etapa, Sala, Horário, Qtd */
      gap:12px;align-items:center;padding:14px;border-bottom:1px dashed #f0e1b6;word-break:break-word;
    }
    .row:nth-child(odd){background:#fff9e9}
    .row.header{
      font-weight:700;color:#111;background:#ffeab9;
      border-top-left-radius:12px;border-top-right-radius:12px;border-bottom:1px solid #f0e1b6
    }
    .row > div{overflow:hidden;text-overflow:ellipsis;min-width:0}
    .center{color:#7a4d00;font-weight:600}
    .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    .footer{color:var(--muted);font-size:12px;text-align:center;margin:24px 0}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{background:#fff;border-radius:16px;max-width:900px;width:100%;max-height:85vh;box-shadow:0 10px 30px rgba(0,0,0,.25);border:1px solid var(--border);display:flex;flex-direction:column}
    .modal header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:14px 16px;z-index:2}
    .modal .title{font-weight:800}
    .modal .subtitle{color:#6b7280;font-size:14px;margin-top:4px}
    .modal .close{background:#fff;border:1px solid #ddd;border-radius:10px;padding:6px 10px;cursor:pointer;float:right}
    .m-body{padding:8px 16px 16px;display:flex;flex-direction:column;gap:8px}
    .m-table{border:1px solid #eee;border-radius:12px;overflow:hidden}
    .m-header{display:grid;grid-template-columns:1.4fr 0.6fr;gap:12px;padding:10px 12px;background:#faf7ee;border-bottom:1px solid #eee;position:sticky;top:0;z-index:1}
    .m-rows{max-height:60vh;overflow-y:auto;}
    .m-row{display:grid;grid-template-columns:1.4fr 0.6fr;gap:12px;padding:10px 12px;border-bottom:1px dashed #eee;background:#fff}
    .m-row:nth-child(odd){background:#fffbf0}

    /* iOS fix */
    html { -webkit-text-size-adjust: 100%; }
    input, select, textarea, button { font-size:16px !important; max-width:100%; box-sizing:border-box; }

    /* MOBILE */
    @media (max-width:800px){
      .hero-brand{flex-direction:column;align-items:flex-start}
      .row{grid-template-columns:1fr;gap:6px;padding:12px}
      .row.header{display:none}
      .row > div{display:flex;gap:6px;flex-wrap:wrap}
      .row > div::before{
        content:attr(data-label);
        flex:0 0 120px;
        font-weight:600;
        color:var(--muted);
      }
      .m-header{grid-template-columns:1fr}
      .m-row{grid-template-columns:1fr}
      .m-row.header{display:none}
    }
  </style>
</head>
<body>
  <header class="card">
    <div class="container">
      <div class="hero-brand card">
        <img src="logo-paroquia.jpg" alt="Paróquia de São Paulo de Luanda" onerror="this.style.display='none'"/>
        <div>
          <div style="font-weight:800;font-size:18px">Paróquia de São Paulo de Luanda</div>
          <div style="font-weight:700;color:#6b7280">Secretariado da Catequese</div>
          <div style="margin-top:6px;font-weight:800;font-size:16px">Lista de Catequistas</div>
          <div style="color:#374151;margin-top:2px">Ano Catequético: <strong>2025/2026</strong></div>
        </div>
      </div>

      <div class="filters">
        <select id="centroFilter"><option value="">Centro (todos)</option></select>
        <select id="etapaFilter"><option value="">Etapa (todas)</option></select>
        <select id="horarioFilter"><option value="">Horário (todos)</option></select>
        <input id="salaSearch" class="sala-field" type="search" inputmode="numeric" placeholder="Sala (ex.: 305)" />
        <input id="catequistaSearch" class="cateq-field" type="search" placeholder="Pesquisar catequista..." />
      </div>

      <div class="actions">
        <button class="btn" id="exportBtn">Exportar XLSX</button>
        <button class="btn secondary" id="printBtn">Imprimir</button>
      </div>

      <div class="stats" id="stats">A carregar…</div>
    </div>
  </header>

  <main class="container">
    <div class="card results" id="results"></div>
  </main>

  <div class="footer">© Paróquia de São Paulo de Luanda — Secretariado da Catequese</div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <header>
        <button class="close" id="modalClose">Fechar ✕</button>
        <div class="title" id="modalTitle">Turma</div>
        <div class="subtitle" id="modalSub">—</div>
      </header>
      <div class="m-body">
        <div class="m-table">
          <div class="m-header">
            <div>Nome</div><div>Nascimento</div>
          </div>
          <div class="m-rows" id="modalRows"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const XLSX_URL = 'dados-catequese.xlsx';
    const TEMPLATE_URL = 'template-export.xlsx'; // teu template com logo/estilos
    // Escrevemos os dados a partir da célula B8 em ambas as folhas:
    const TEMPLATE_START_A1 = 'B8';
    const TEMPLATE_DATE_CELL = 'B6';

    const norm = (s)=> (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const fmtDate = (s)=>{
      if(!s) return '';
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return s;
      const d = new Date(s);
      if(!isNaN(d)){const dd=String(d.getDate()).padStart(2,'0');const mm=String(d.getMonth()+1).padStart(2,'0');const yy=d.getFullYear();return `${dd}/${mm}/${yy}`;}
      const m = s.match(/^(\d{1,2})[-.](\d{1,2})[-.](\d{4})$/);
      if(m){const dd=m[1].padStart(2,'0');const mm=m[2].padStart(2,'0');return `${dd}/${mm}/${m[3]}`;}
      return s;
    };
    const key = (s)=>norm(s).replace(/[^a-z0-9]/g,'');

    function mapHeaders(cols){
      const wanted = {
        nome:['nome','nomecompleto'],
        nascimento:['nascimento','datanascimento','data','dn'],
        centro:['centro','centrodecatequese','paroquia','comunidade'],
        etapa:['etapa','etapacatequese','nivel','ano','classe'],
        sala:['sala','numerosala','turma','salaaula'],
        horario:['horario','hora','turno','periodo','diaehora','diahora'],
        catequistas:['catequistas','catequista','responsaveis','responsavel']
      };
      const idx = {};
      cols.forEach((c,i)=>{
        const k = key(c);
        for(const [t, aliases] of Object.entries(wanted)){ if(aliases.includes(k)) idx[t]=i; }
      });
      return idx;
    }

    function uniq(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt')); }

    // monta grupos (catequista, centro, etapa, sala, horario)
    function buildGroups(DATA){
      const groups = new Map();
      for(const d of DATA){
        const raw = String(d.catequistas||'');
        if(!raw.trim()) continue;
        const parts = raw.split('|').map(s=>s.trim()).filter(Boolean);
        for(const cateq of parts){
          const k = [cateq, d.centro, d.etapa, d.sala, d.horario].join('§');
          if(!groups.has(k)){
            groups.set(k, {
              catequista: cateq,
              centro: d.centro,
              etapa: d.etapa,
              sala: d.sala,
              horario: d.horario,
              alunos: []
            });
          }
          groups.get(k).alunos.push({nome: d.nome, nascimento_fmt: d.nascimento_fmt});
        }
      }
      for(const g of groups.values()){
        g.alunos.sort((a,b)=>a.nome.localeCompare(b.nome,'pt'));
      }
      return Array.from(groups.values());
    }

    function render(list){
      const results = document.getElementById('results');
      results.innerHTML = '';

      const header = document.createElement('div');
      header.className = 'row header';
      header.innerHTML = `<div>Catequista</div><div>Centro</div><div>Etapa</div><div>Sala</div><div>Horário</div><div>Catecúmenos</div>`;
      results.appendChild(header);

      const frag = document.createDocumentFragment();
      for(const g of list){
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `
          <div data-label="Catequista">${g.catequista}</div>
          <div data-label="Centro" class="center">${g.centro}</div>
          <div data-label="Etapa">${g.etapa}</div>
          <div data-label="Sala">${g.sala}</div>
          <div data-label="Horário">${g.horario}</div>
          <div data-label="Catecúmenos"><button class="btn secondary" data-open="modal" data-key="${encodeURIComponent([g.catequista,g.centro,g.etapa,g.sala,g.horario].join('§'))}">${g.alunos.length}</button></div>
        `;
        frag.appendChild(row);
      }
      results.appendChild(frag);

      results.querySelectorAll('button[data-open="modal"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const k = decodeURIComponent(btn.getAttribute('data-key'));
          const [catequista,centro,etapa,sala,horario] = k.split('§');
          const grp = list.find(g => g.catequista===catequista && g.centro===centro && g.etapa===etapa && g.sala===sala && g.horario===horario);
          if(grp) openModal(grp);
        });
      });
    }

    function openModal(group){
      const bd = document.getElementById('modalBackdrop');
      const title = document.getElementById('modalTitle');
      const sub = document.getElementById('modalSub');
      const rowsWrap = document.getElementById('modalRows');

      title.textContent = `Turma de ${group.catequista}`;
      sub.textContent = `${group.centro} • ${group.etapa} • Sala ${group.sala} • ${group.horario}`;

      rowsWrap.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(const a of group.alunos){
        const r = document.createElement('div');
        r.className = 'm-row';
        r.innerHTML = `<div>${a.nome}</div><div>${a.nascimento_fmt || '-'}</div>`;
        frag.appendChild(r);
      }
      rowsWrap.appendChild(frag);

      bd.style.display = 'flex';
      bd.setAttribute('aria-hidden','false');
      setTimeout(()=>document.getElementById('modalClose').focus(), 50);
    }
    function closeModal(){
      const bd = document.getElementById('modalBackdrop');
      bd.style.display = 'none';
      bd.setAttribute('aria-hidden','true');
    }
    document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    document.getElementById('printBtn').addEventListener('click', ()=>window.print());

    let CURRENT_GROUPS = [];
    let CURRENT_FILTERED = [];

    function updateStats(filtered){
      const totalTurmas = filtered.length;
      const uniqueCats = new Set(filtered.map(g => g.catequista)).size;
      document.getElementById('stats').textContent =
        `${totalTurmas} turma${totalTurmas===1?'':'s'} | ${uniqueCats} catequista${uniqueCats===1?'':'s'}`;
    }

    // ===================== EXPORT COM TEMPLATE (B8) =====================

    function nowStamp(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    }

    // Escreve uma matriz (AOA) a partir de uma célula A1 (ex.: "B8") e atualiza o !ref
    function writeAOAAt(ws, startA1, aoa){
      const start = XLSX.utils.decode_cell(startA1);
      const startR = start.r, startC = start.c;
      const rows = aoa.length;
      const cols = aoa[0] ? aoa[0].length : 0;

      for(let i=0;i<rows;i++){
        for(let j=0;j<cols;j++){
          const addr = XLSX.utils.encode_cell({ r: startR + i, c: startC + j });
          const val  = aoa[i][j];
          ws[addr] = { t:'s', v: (val==null ? '' : String(val)) };
        }
      }

      // Atualiza o !ref para abranger o que foi escrito
      const old = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
      const newRange = {
        s: { r: Math.min(old.s.r, startR), c: Math.min(old.s.c, startC) },
        e: { r: Math.max(old.e.r, startR + rows - 1), c: Math.max(old.e.c, startC + cols - 1) }
      };
      ws['!ref'] = XLSX.utils.encode_range(newRange);
    }

    async function exportUsingTemplate(filtered) {
      const r = await fetch(TEMPLATE_URL + '?v=' + Date.now());
      if (!r.ok) throw new Error('Falha ao carregar template (' + r.status + ')');
      const buf = await r.arrayBuffer();
      const wb  = XLSX.read(buf, { type:'array' });

      // Dados para as duas folhas
      const resumoHeader = ['Catequista','Centro','Etapa','Sala','Horario','Catecumenos'];
      const resumoBody   = filtered.map(g => [g.catequista, g.centro, g.etapa, g.sala, g.horario, g.alunos.length]);

      const detalheHeader= ['Centro','Etapa','Sala','Horario','Catequista','Nome','Nascimento'];
      const detalheBody  = [];
      for(const g of filtered){
        for(const a of g.alunos){
          detalheBody.push([g.centro, g.etapa, g.sala, g.horario, g.catequista, a.nome, a.nascimento_fmt || '']);
        }
      }
      detalheBody.sort((x,y)=>
        x[0].localeCompare(y[0],'pt') ||
        x[1].localeCompare(y[1],'pt') ||
        String(x[2]).localeCompare(String(y[2]),'pt') ||
        x[4].localeCompare(y[4],'pt') ||
        x[5].localeCompare(y[5],'pt')
      );

      // Folhas
      const wsRes = wb.Sheets['Catequistas'];
      const wsDet = wb.Sheets['Detalhe'];
      if(!wsRes) throw new Error('Folha "Catequistas" não encontrada no template.');
      if(!wsDet) throw new Error('Folha "Detalhe" não encontrada no template.');

      // Atualiza B6 (DATA_GERACAO)
      wsRes[TEMPLATE_DATE_CELL] = wsRes[TEMPLATE_DATE_CELL] || { t:'s', v:'' };
      wsDet[TEMPLATE_DATE_CELL] = wsDet[TEMPLATE_DATE_CELL] || { t:'s', v:'' };
      wsRes[TEMPLATE_DATE_CELL].v = 'Data de geração: ' + nowStamp();
      wsDet[TEMPLATE_DATE_CELL].v = 'Data de geração: ' + nowStamp();

      // Escreve as tabelas a partir de B8 (linha 8 é o cabeçalho)
      writeAOAAt(wsRes, TEMPLATE_START_A1, [resumoHeader, ...resumoBody]);
      writeAOAAt(wsDet, TEMPLATE_START_A1, [detalheHeader, ...detalheBody]);

      // Salva
      XLSX.writeFile(wb, 'catequistas_filtrado.xlsx');
    }

    function exportFallback(filtered){
      const headerResumo = ['Catequista','Centro','Etapa','Sala','Horario','Catecumenos'];
      const bodyResumo   = filtered.map(g => [g.catequista, g.centro, g.etapa, g.sala, g.horario, g.alunos.length]);

      const headerDet = ['Centro','Etapa','Sala','Horario','Catequista','Nome','Nascimento'];
      const bodyDet   = [];
      for(const g of filtered){
        for(const a of g.alunos){
          bodyDet.push([g.centro, g.etapa, g.sala, g.horario, g.catequista, a.nome, a.nascimento_fmt || '']);
        }
      }

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headerResumo, ...bodyResumo]), 'Catequistas');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headerDet,   ...bodyDet]),   'Detalhe');
      XLSX.writeFile(wb, 'catequistas_filtrado.xlsx');
    }

    async function exportXLSX_TemplateFirst(filtered){
      try{
        await exportUsingTemplate(filtered);
      }catch(err){
        console.error('[Template] Erro ao usar template:', err);
        alert('Não consegui usar o template. Vou gerar um ficheiro simples sem layout.');
        exportFallback(filtered);
      }
    }
    // ===================== FIM EXPORT COM TEMPLATE (B8) =====================

    document.getElementById('printBtn').addEventListener('click', ()=>window.print());
    document.getElementById('exportBtn').addEventListener('click', ()=>exportXLSX_TemplateFirst(CURRENT_FILTERED));

    function applySearchFactory(GROUPS){
      const centroFilter = document.getElementById('centroFilter');
      const etapaFilter  = document.getElementById('etapaFilter');
      const horarioFilter= document.getElementById('horarioFilter');
      const salaSearch   = document.getElementById('salaSearch');
      const cateqSearch  = document.getElementById('catequistaSearch');

      function populate(){
        centroFilter.innerHTML = '<option value="">Centro (todos)</option>';
        etapaFilter.innerHTML  = '<option value="">Etapa (todas)</option>';
        horarioFilter.innerHTML= '<option value="">Horário (todos)</option>';
        for(const c of uniq(GROUPS.map(g=>g.centro))){ const o=document.createElement('option'); o.value=c; o.textContent=c; centroFilter.appendChild(o); }
        for(const e of uniq(GROUPS.map(g=>g.etapa))){ const o=document.createElement('option'); o.value=e; o.textContent=e; etapaFilter.appendChild(o); }
        for(const h of uniq(GROUPS.map(g=>g.horario))){ const o=document.createElement('option'); o.value=h; o.textContent=h; horarioFilter.appendChild(o); }
      }

      function apply(){
        const salaQ = norm(salaSearch.value);
        const cateqQ= norm(catequistaSearch.value);
        const fCentro = centroFilter.value;
        const fEtapa  = etapaFilter.value;
        const fHorario= horarioFilter.value;

        let list = GROUPS.slice();
        if(fCentro)   list = list.filter(g => g.centro === fCentro);
        if(fEtapa)    list = list.filter(g => g.etapa === fEtapa);
        if(fHorario)  list = list.filter(g => g.horario === fHorario);
        if(salaQ)     list = list.filter(g => norm(String(g.sala)).includes(salaQ));
        if(cateqQ)    list = list.filter(g => norm(g.catequista).includes(cateqQ));

        list.sort((a,b)=>{
          return a.centro.localeCompare(b.centro,'pt') ||
                 a.etapa.localeCompare(b.etapa,'pt')   ||
                 String(a.sala).localeCompare(String(b.sala),'pt') ||
                 a.catequista.localeCompare(b.catequista,'pt');
        });

        CURRENT_FILTERED = list;
        render(list);
        updateStats(list);
      }

      let t;
      function deb(){ clearTimeout(t); t=setTimeout(apply, 80); }

      salaSearch.addEventListener('input', deb);
      cateqSearch.addEventListener('input', deb);
      centroFilter.addEventListener('change', apply);
      etapaFilter.addEventListener('change', apply);
      horarioFilter.addEventListener('change', apply);

      populate(); apply();
    }

    async function load(){
      const url = XLSX_URL + '?v=' + Date.now();
      const r = await fetch(url);
      if(!r.ok) throw new Error('XLSX fetch HTTP ' + r.status);
      const buf = await r.arrayBuffer();
      const wb  = XLSX.read(buf, {type:'array'});

      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      if(!json.length) throw new Error('XLSX vazio na 1ª folha.');
      const headers = json[0].map(String);
      const idx = mapHeaders(headers);
      const req = ['nome','nascimento','centro','etapa','sala','horario','catequistas'];
      const missing = req.filter(k => !(k in idx));
      if(missing.length) throw new Error('Cabeçalhos ausentes: ' + missing.join(', '));

      const rows = json.slice(1).filter(r => r.some(v => String(v).trim() !== ''));
      const DATA = rows.map(r => ({
        nome: r[idx.nome] ?? '',
        nascimento: r[idx.nascimento] ?? '',
        centro: r[idx.centro] ?? '',
        etapa: r[idx.etapa] ?? '',
        sala: r[idx.sala] ?? '',
        horario: r[idx.horario] ?? '',
        catequistas: r[idx.catequistas] ?? ''
      }));
      DATA.forEach(d => d.nascimento_fmt = fmtDate(d.nascimento));

      const GROUPS = buildGroups(DATA);
      CURRENT_GROUPS = GROUPS;
      applySearchFactory(GROUPS);
    }

    (async ()=>{
      try{ await load(); }
      catch(err){
        document.getElementById('stats').textContent = 'Falha ao carregar.';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
